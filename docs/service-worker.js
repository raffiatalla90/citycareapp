const CACHE_NAME="story-app-v1",RUNTIME_CACHE="story-app-runtime-v1",IMAGE_CACHE="story-app-images-v1",STATIC_ASSETS=["index.html","app.css","app.bundle.js","manifest.json"];async function networkFirstStrategy(e){try{const t=await fetch(e);return t.ok&&(await caches.open(RUNTIME_CACHE)).put(e,t.clone()),t}catch(t){console.log("[Service Worker] Network request failed, trying cache:",t);const o=await caches.match(e);if(o)return o;throw t}}async function cacheFirstStrategy(e,t){const o=await caches.match(e);if(o)return o;try{const o=await fetch(e);return o.ok&&(await caches.open(t)).put(e,o.clone()),o}catch(e){throw console.log("[Service Worker] Failed to fetch:",e),e}}async function staleWhileRevalidateStrategy(e){const t=await caches.open(RUNTIME_CACHE),o=await caches.match(e),n=fetch(e).then((o=>(o.ok&&t.put(e,o.clone()),o))).catch((()=>o));return o||n}async function syncOfflineStories(){try{console.log("[Service Worker] Syncing offline stories...");const e=await openDatabase(),t=await getOfflineStories(e);if(0===t.length)return void console.log("[Service Worker] No offline stories to sync");console.log(`[Service Worker] Found ${t.length} offline stories to sync`);for(const o of t)try{const t=new FormData;if(t.append("description",o.description),o.photo){const e=await fetch(o.photo).then((e=>e.blob()));t.append("photo",e,"photo.jpg")}o.lat&&o.lon&&(t.append("lat",o.lat),t.append("lon",o.lon)),(await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${o.token}`},body:t})).ok&&(console.log("[Service Worker] Story synced successfully:",o.id),await deleteOfflineStory(e,o.id),(await self.clients.matchAll()).forEach((e=>{e.postMessage({type:"STORY_SYNCED",storyId:o.id})})))}catch(e){console.error("[Service Worker] Failed to sync story:",e)}}catch(e){throw console.error("[Service Worker] Sync failed:",e),e}}function openDatabase(){return new Promise(((e,t)=>{const o=indexedDB.open("StoryAppDB",1);o.onerror=()=>t(o.error),o.onsuccess=()=>e(o.result)}))}function getOfflineStories(e){return new Promise(((t,o)=>{const n=e.transaction(["offline-stories"],"readonly").objectStore("offline-stories").getAll();n.onerror=()=>o(n.error),n.onsuccess=()=>t(n.result||[])}))}function deleteOfflineStory(e,t){return new Promise(((o,n)=>{const i=e.transaction(["offline-stories"],"readwrite").objectStore("offline-stories").delete(t);i.onerror=()=>n(i.error),i.onsuccess=()=>o()}))}self.addEventListener("install",(e=>{console.log("[Service Worker] Installing..."),e.waitUntil(caches.open(CACHE_NAME).then((e=>{console.log("[Service Worker] Caching static assets");const t=self.location.pathname.substring(0,self.location.pathname.lastIndexOf("/")+1),o=STATIC_ASSETS.map((e=>new URL(e,self.location.origin+t).href));return console.log("[Service Worker] URLs to cache:",o),e.addAll(o).catch((e=>{console.error("[Service Worker] Cache addAll failed:",e)}))}))),self.skipWaiting()})),self.addEventListener("activate",(e=>{console.log("[Service Worker] Activating..."),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(e!==CACHE_NAME&&e!==RUNTIME_CACHE&&e!==IMAGE_CACHE)return console.log("[Service Worker] Deleting old cache:",e),caches.delete(e)})))))),self.clients.claim()})),self.addEventListener("fetch",(e=>{const{request:t}=e;new URL(t.url).origin.includes("story-api.dicoding.dev")?e.respondWith(networkFirstStrategy(t)):"image"!==t.destination?e.respondWith(staleWhileRevalidateStrategy(t)):e.respondWith(cacheFirstStrategy(t,IMAGE_CACHE))})),self.addEventListener("push",(e=>{console.log("[Service Worker] Push notification received:",e);let t={title:"Story App",body:"You have a new notification",icon:"./images/icon-192x192.png",badge:"./images/icon-96x96.png",vibrate:[200,100,200],tag:"story-notification",requireInteraction:!1};if(e.data)try{const o=e.data.json();console.log("[Service Worker] Push data:",o),t={title:o.title||"New Story Added!",body:o.body||o.message||"Someone shared a new story",icon:o.icon||"./images/icon-192x192.png",badge:"./images/icon-96x96.png",image:o.image||null,vibrate:[200,100,200],tag:o.tag||"story-notification",requireInteraction:!1,data:{url:o.url||"./#/home",storyId:o.storyId||null},actions:[{action:"view",title:"View Story",icon:"./images/icon-view.png"},{action:"close",title:"Close",icon:"./images/icon-close.png"}]}}catch(e){console.error("[Service Worker] Error parsing push data:",e)}e.waitUntil(self.registration.showNotification(t.title,t))})),self.addEventListener("notificationclick",(e=>{if(console.log("[Service Worker] Notification clicked:",e.action),e.notification.close(),"close"===e.action)return;const t=e.notification.data?.url||"/#/home";e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{for(let o of e)if(o.url.includes(self.location.origin)&&"focus"in o)return o.focus(),void o.navigate(t);if(clients.openWindow)return clients.openWindow(t)})))})),self.addEventListener("sync",(e=>{console.log("[Service Worker] Background sync:",e.tag),"sync-stories"===e.tag&&e.waitUntil(syncOfflineStories())}));